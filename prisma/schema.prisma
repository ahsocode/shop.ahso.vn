// ================================================
// GENERATORS & DATASOURCE (gi·ªØ nguy√™n theo d·ª± √°n g·ªëc)
// ================================================
generator client_types {
  provider = "prisma-client"
  output   = "../generated"
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ================================================
// ENUMS H·ªÜ TH·ªêNG (g·ªëc)
// ================================================
enum Role {
  USER
  STAFF
  ADMIN
}

enum OrderStatus {
  pending
  paid
  processing
  shipped
  delivered
  cancelled
}

// ================================================
// USER / ADDRESS / ORDER / PAYMENT (g·ªëc)
// ================================================
model User {
  id            String   @id @default(cuid())
  username      String   @unique
  passwordHash  String
  fullName      String
  email         String   @unique
  phoneE164     String   @unique
  taxCode       String?  @db.VarChar(13)
  emailVerified Boolean  @default(false)
  role          Role     @default(USER)
  avatarUrl     String?  @default("/logo.png")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Li√™n k·∫øt ƒë·∫øn Address (shipping/billing)
  shippingAddressId String   @unique
  billingAddressId  String?  @unique
  shippingAddress   Address  @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress    Address? @relation("BillingAddress", fields: [billingAddressId], references: [id])

  // Back-relation User <-> Order
  orders Order[] @relation("UserOrders")
}

model Address {
  id         String   @id @default(cuid())
  line1      String
  line2      String?
  city       String
  state      String?
  postalCode String?
  country    String   @db.Char(2) // ISO-3166-1 alpha-2 (VD: "VN","DE")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  usersShipping User[] @relation("ShippingAddress")
  usersBilling  User[] @relation("BillingAddress")

  // Back-relation cho Order <-> Address
  orders Order[] @relation("OrderAddress")
}

model Order {
  id             String      @id @default(cuid())
  code           String      @unique
  status         OrderStatus @default(pending)
  customerName   String
  shippingMethod String?
  shippingFee    Int?
  note           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 1 - n OrderItem
  items OrderItem[]

  // 1 - 1 Payment
  payment Payment?

  // n - 1 Address (ƒë·ªãa ch·ªâ ƒë∆°n h√†ng)
  address   Address? @relation("OrderAddress", fields: [addressId], references: [id])
  addressId String?

  // n - 1 User (ch·ªß ƒë∆°n)
  user   User?   @relation("UserOrders", fields: [userId], references: [id])
  userId String?

  @@index([addressId])
  @@index([userId])
}

model OrderItem {
  id String @id @default(cuid())

  order   Order  @relation(fields: [orderId], references: [id])
  orderId String

  sku      String
  name     String
  quantity Int
  price    Int
  image    String?
}

model Payment {
  id String @id @default(cuid())

  // 1-1 v·ªõi Order
  order   Order  @relation(fields: [orderId], references: [id])
  orderId String @unique

  method String // "cod" | "vnpay" | "credit" | "bank"
  amount Int
  paidAt DateTime? @default(now())
}

// ================================================
// SOLUTION CATALOG (g·ªëc)
// ================================================
enum PublishStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model SolutionCategory {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  image       String?

  parentId String?
  parent   SolutionCategory?  @relation("SolutionCategoryToParent", fields: [parentId], references: [id])
  children SolutionCategory[] @relation("SolutionCategoryToParent")

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  solutions Solution[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId, sortOrder])
}

model Solution {
  id         String  @id @default(cuid())
  title      String
  slug       String  @unique
  summary    String?
  coverImage String?
  bodyHtml   String  @db.LongText

  industry String?
  usecase  String?

  status      PublishStatus @default(DRAFT)
  publishedAt DateTime?

  metaTitle       String?
  metaDescription String?
  canonicalUrl    String?

  categoryId String
  category   SolutionCategory @relation(fields: [categoryId], references: [id])

  images SolutionImage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId, status])
  @@fulltext([title, bodyHtml, usecase])
}

model SolutionImage {
  id         String   @id @default(cuid())
  solutionId String
  solution   Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  url       String
  alt       String?
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())

  @@index([solutionId, sortOrder])
}

// ================================================
// SOFTWARE CATALOG (g·ªëc)
// ================================================
model SoftwareCategory {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  image       String?

  parentId String?
  parent   SoftwareCategory?  @relation("SoftwareCategoryToParent", fields: [parentId], references: [id])
  children SoftwareCategory[] @relation("SoftwareCategoryToParent")

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  softwares Software[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId, sortOrder])
}

model Software {
  id         String  @id @default(cuid())
  title      String
  slug       String  @unique
  summary    String?
  coverImage String?
  bodyHtml   String  @db.LongText

  status      PublishStatus @default(DRAFT)
  publishedAt DateTime?

  // SEO
  metaTitle       String?
  metaDescription String?
  canonicalUrl    String?

  categoryId String
  category   SoftwareCategory @relation(fields: [categoryId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId, status])
  @@fulltext([title, bodyHtml])
}

// =====================================================
// ========== PRODUCT CATALOG (ƒë√£ ƒëi·ªÅu ch·ªânh) ==========
// =====================================================

// ---- ƒê∆°n v·ªã t√≠nh / Lo·∫°i t√†i li·ªáu / Tr·∫°ng th√°i gi·ªè ----
enum Unit {
  PCS
  BOX
  SET
  ROLL
  METER
  LITER
  KILOGRAM
}

enum DocType {
  DATASHEET
  MANUAL
  CERT
  OTHER
}

enum CartStatus {
  ACTIVE
  CHECKED_OUT
  ABANDONED
}

// ---- Th∆∞∆°ng hi·ªáu ----
model Brand {
  id                String  @id @default(cuid())
  name              String
  slug              String  @unique
  originCountryCode String? @db.Char(2)
  logoUrl           String?

  products Product[]

  // üî¢ B·ªô ƒë·∫øm nhanh s·ªë VARIANT thu·ªôc brand n√†y
  variantCount Int @default(0)

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  ProductVariant ProductVariant[]

  @@index([slug])
  @@index([variantCount])
}

// ---- Danh m·ª•c d·∫°ng c√¢y (multi-level) ----
model Category {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  fullSlug    String  @unique
  level       Int     @default(0)
  description String?
  icon        String?

  parentId String?
  parent   Category?  @relation("CatToCat", fields: [parentId], references: [id])
  children Category[] @relation("CatToCat")

  productLinks ProductCategory[]

  // üî¢ B·ªô ƒë·∫øm nhanh
  productCount Int @default(0) // s·ªë Product (distinct) g·∫Øn v·ªõi category
  variantCount Int @default(0) // t·ªïng s·ªë Variant thu·ªôc c√°c Product trong category

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([level])
  @@index([fullSlug])
  @@index([productCount])
  @@index([variantCount])
}

model ProductCategory {
  productId  String
  categoryId String

  product  Product  @relation(fields: [productId], references: [id])
  category Category @relation(fields: [categoryId], references: [id])

  @@id([productId, categoryId])
  @@index([categoryId])
}

// ---- Product (khung m√¥ t·∫£ + SEO; giao d·ªãch qua Variant) ----
model Product {
  id              String  @id @default(cuid())
  title           String
  slug            String  @unique
  sku             String  @unique
  mpn             String?
  summary         String?
  descriptionHtml String?
  imagesCover     String?
  unit            Unit    @default(PCS)

  // SEO
  metaTitle       String?
  metaDescription String?
  canonicalUrl    String?

  // Tr·∫°ng th√°i ph√°t h√†nh
  status    PublishStatus @default(DRAFT)
  publishAt DateTime?

  // Th∆∞∆°ng hi·ªáu (hi·ªÉn th·ªã ·ªü listing; details n·∫±m ·ªü Variant)
  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id])

  // Xu·∫•t x·ª© m·∫∑c ƒë·ªãnh
  madeInCountryCode String? @db.Char(2)
  madeInNote        String?

  // Quan h·ªá con
  variants ProductVariant[]

  images ProductImage[]
  docs   ProductDoc[]

  // Li√™n k·∫øt danh m·ª•c
  categoryLinks ProductCategory[]

  // (Tu·ª≥ ch·ªçn) denormalized ƒë·ªÉ sort/filter nhanh ·ªü listing
  priceMin Decimal? @db.Decimal(12, 2)
  priceMax Decimal? @db.Decimal(12, 2)

  // üî¢ B·ªô ƒë·∫øm nhanh s·ªë VARIANT c·ªßa s·∫£n ph·∫©m n√†y
  variantCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status, publishAt])
  @@index([madeInCountryCode])
  @@index([variantCount])
}

// ---- ProductVariant (th·ª±c th·ªÉ giao d·ªãch) ----
model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])

  // üîÅ M√É/BARCODES/BRAND ·ªü c·∫•p VARIANT
  variantSku String  @unique
  mpn        String?
  barcode    String?
  brandId    String?
  brand      Brand?  @relation(fields: [brandId], references: [id])

  // Thu·ªôc t√≠nh hi·ªÉn th·ªã (size, spec‚Ä¶) d·∫°ng JSON
  attributes Json

  // Gi√°
  price       Decimal  @db.Decimal(12, 2)
  listPrice   Decimal? @db.Decimal(12, 2)
  currency    String   @default("VND")
  taxIncluded Boolean  @default(true)

  // Kho
  stockOnHand   Int     @default(0)
  stockReserved Int     @default(0)
  warehouseId   String?
  leadTimeDays  Int?
  minOrderQty   Int?    @default(1)
  packInner     Int?
  packOuter     Int?

  // V·∫≠n chuy·ªÉn/ƒë√≥ng g√≥i
  weightGrams Int?
  lengthMm    Int?
  widthMm     Int?
  heightMm    Int?

  // Xu·∫•t x·ª© c·ª• th·ªÉ c·ªßa VARIANT (override Product)
  madeInCountryCode String? @db.Char(2)
  madeInNote        String?

  // Specs ƒë·ªông theo VARIANT (t√πy)
  specs ProductSpec[]

  // Back-relation t·ªõi CartItem
  cartItems CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([variantSku])
  @@index([brandId])
  @@index([madeInCountryCode])
}

model ProductSpec {
  id String @id @default(cuid())

  // ‚ùå B·ªé productId, product
  // productId String
  // product   Product @relation(fields: [productId], references: [id])

  // ‚úÖ B·∫ÆT BU·ªòC g·∫Øn Variant
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  keySlug     String
  label       String
  valueText   String?
  valueNumber Decimal? @db.Decimal(20, 6)
  unit        String?
  sortOrder   Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([variantId, keySlug]) // tr√°nh tr√πng spec theo key
  @@index([keySlug, valueText])
  @@index([keySlug, valueNumber])
}

// ---- H√¨nh ·∫£nh & t√†i li·ªáu k√®m Product ----
model ProductImage {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])

  url       String
  alt       String?
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([sortOrder])
}

model ProductDoc {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])

  title   String
  fileUrl String
  type    DocType @default(DATASHEET)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([type])
}

// ---- Cart / CartItem (gi·ªè h√†ng theo VARIANT) ----
model Cart {
  id     String     @id @default(cuid())
  userId String?
  items  CartItem[]
  status CartStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model CartItem {
  id     String @id @default(cuid())
  cartId String
  cart   Cart   @relation(fields: [cartId], references: [id])

  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  quantity   Int      @default(1)
  unitPrice  Decimal  @db.Decimal(12, 2)
  totalPrice Decimal  @db.Decimal(12, 2)
  addedAt    DateTime @default(now())

  @@index([cartId])
  @@index([variantId])
}
