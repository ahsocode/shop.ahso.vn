generator client_types {
  provider = "prisma-client"
  output   = "../generated"
}

// TH√äM generator CHU·∫®N ƒë·ªÉ seed/API d√πng @prisma/client
generator client {
  provider = "prisma-client-js"
  // ƒë·ªÉ tr·ªëng output -> Prisma build v√†o node_modules/@prisma/client
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}
enum Role {
  USER
  STAFF
  ADMIN
}

enum OrderStatus {
  pending
  paid
  processing
  shipped
  delivered
  cancelled
}

model User {
  id            String   @id @default(cuid())
  username      String   @unique
  passwordHash  String
  fullName      String
  email         String   @unique
  phoneE164     String   @unique
  taxCode       String?  @db.VarChar(13)
  emailVerified Boolean  @default(false)
  role          Role     @default(USER)
  avatarUrl     String?  @default("/logo.png")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  shippingAddressId String  @unique
  billingAddressId  String? @unique

  // Quan h·ªá User <-> Address ƒë√£ c√≥
  shippingAddress Address  @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress  Address? @relation("BillingAddress", fields: [billingAddressId], references: [id])

  // üîπ Back-relation cho User <-> Order (m·ªôt user c√≥ th·ªÉ c√≥ nhi·ªÅu order)
  orders Order[] @relation("UserOrders")
}

model Address {
  id         String   @id @default(cuid())
  line1      String
  line2      String?
  city       String
  state      String?
  postalCode String?
  country    String   @db.Char(2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Quan h·ªá c√≥ s·∫µn v·ªõi User
  usersShipping User[] @relation("ShippingAddress")
  usersBilling  User[] @relation("BillingAddress")

  // üîπ Back-relation cho Order <-> Address
  orders Order[] @relation("OrderAddress")
}

model Order {
  id             String      @id @default(cuid())
  code           String      @unique
  status         OrderStatus @default(pending)
  customerName   String
  shippingMethod String?
  shippingFee    Int?
  note           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîπ Quan h·ªá Order <-> OrderItem (1 - n)
  items OrderItem[]

  // üîπ Quan h·ªá Order <-> Payment (1 - 1). `orderId` ph·∫£i UNIQUE ƒë·ªÉ Prisma hi·ªÉu 1-1
  payment Payment?

  // üîπ Quan h·ªá Order <-> Address (n - 1) v·ªõi t√™n "OrderAddress"
  address   Address? @relation("OrderAddress", fields: [addressId], references: [id])
  addressId String?

  // üîπ Quan h·ªá Order <-> User (n - 1) v·ªõi t√™n "UserOrders"
  user   User?   @relation("UserOrders", fields: [userId], references: [id])
  userId String?

  @@index([addressId])
  @@index([userId])
}

model OrderItem {
  id String @id @default(cuid())

  // üîπ Nhi·ªÅu item thu·ªôc 1 order
  order   Order  @relation(fields: [orderId], references: [id])
  orderId String

  sku      String
  name     String
  quantity Int
  price    Int
  image    String?
}

model Payment {
  id String @id @default(cuid())

  // üîπ 1-1 v·ªõi Order: orderId ph·∫£i UNIQUE ƒë·ªÉ kh√¥ng th√†nh 1-n
  order   Order  @relation(fields: [orderId], references: [id])
  orderId String @unique

  method String // "cod" | "vnpay" | "credit" | "bank" (string ƒë·ªÉ linh ho·∫°t)
  amount Int
  paidAt DateTime? @default(now())
}
// ===============================
// SOLUTION CATALOG
// ===============================

enum PublishStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model SolutionCategory {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  image       String?            // ·∫£nh bi·ªÉu tr∆∞ng category (n·∫øu c·∫ßn)

  // Ph√¢n c·∫•p (t√πy ch·ªçn). N·∫øu kh√¥ng d√πng ph√¢n c·∫•p: gi·ªØ parentId = null
  parentId    String?
  parent      SolutionCategory?  @relation("SolutionCategoryToParent", fields: [parentId], references: [id])
  children    SolutionCategory[] @relation("SolutionCategoryToParent")

  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  // Quan h·ªá
  solutions   Solution[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([parentId, sortOrder])
}

model Solution {
  id            String         @id @default(cuid())
  title         String
  slug          String         @unique
  summary       String?        // m√¥ t·∫£ ng·∫Øn ƒë·ªÉ hi·ªÉn th·ªã ·ªü card
  coverImage    String?        // ·∫£nh ch√≠nh (URL)
  bodyHtml      String         @db.LongText // n·ªôi dung HTML chi ti·∫øt (copy t·ª´ editor/CMS)

  // L·ªçc/hi·ªÉn th·ªã theo UI t√¨m ki·∫øm hi·ªán t·∫°i (t√πy ch·ªçn)
  industry      String?        // v√≠ d·ª•: "food", "auto", "electronics"‚Ä¶
  usecase       String?        // v√≠ d·ª•: "palletizing", "packaging"‚Ä¶

  // Tr·∫°ng th√°i hi·ªÉn th·ªã
  status        PublishStatus  @default(DRAFT)
  publishedAt   DateTime?

  // SEO c∆° b·∫£n (t√πy ch·ªçn)
  metaTitle       String?
  metaDescription String?
  canonicalUrl    String?

  // Quan h·ªá Category
  categoryId    String
  category      SolutionCategory @relation(fields: [categoryId], references: [id])

  // Th∆∞ vi·ªán ·∫£nh n-·∫£nh
  images        SolutionImage[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Ch·ªâ m·ª•c ph·ª•c v·ª• search/list nhanh
  @@index([categoryId, status])
  @@fulltext([title, bodyHtml, usecase]) // MySQL 8+ (InnoDB) h·ªó tr·ª£ FULLTEXT
}

model SolutionImage {
  id         String   @id @default(cuid())
  solutionId String
  solution   Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  url        String   // ch·ªâ l∆∞u link ·∫£nh
  alt        String?  // m√¥ t·∫£ ·∫£nh cho SEO/a11y
  sortOrder  Int      @default(0)

  createdAt  DateTime @default(now())

  @@index([solutionId, sortOrder])
}
