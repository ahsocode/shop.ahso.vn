generator client {
  provider = "prisma-client"
  output   = "../generated"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  STAFF
  ADMIN
}

enum OrderStatus {
  pending
  paid
  processing
  shipped
  delivered
  cancelled
}

model User {
  id            String   @id @default(cuid())
  username      String   @unique
  passwordHash  String
  fullName      String
  email         String   @unique
  phoneE164     String   @unique
  taxCode       String?  @db.VarChar(13)
  emailVerified Boolean  @default(false)
  role          Role     @default(USER)
  avatarUrl     String?  @default("/logo.png")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  shippingAddressId String  @unique
  billingAddressId  String? @unique

  // Quan há»‡ User <-> Address Ä‘Ã£ cÃ³
  shippingAddress Address  @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress  Address? @relation("BillingAddress", fields: [billingAddressId], references: [id])

  // ğŸ”¹ Back-relation cho User <-> Order (má»™t user cÃ³ thá»ƒ cÃ³ nhiá»u order)
  orders Order[] @relation("UserOrders")
}

model Address {
  id         String   @id @default(cuid())
  line1      String
  line2      String?
  city       String
  state      String?
  postalCode String?
  country    String   @db.Char(2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Quan há»‡ cÃ³ sáºµn vá»›i User
  usersShipping User[] @relation("ShippingAddress")
  usersBilling  User[] @relation("BillingAddress")

  // ğŸ”¹ Back-relation cho Order <-> Address
  orders Order[] @relation("OrderAddress")
}

model Order {
  id             String      @id @default(cuid())
  code           String      @unique
  status         OrderStatus @default(pending)
  customerName   String
  shippingMethod String?
  shippingFee    Int?
  note           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ğŸ”¹ Quan há»‡ Order <-> OrderItem (1 - n)
  items OrderItem[]

  // ğŸ”¹ Quan há»‡ Order <-> Payment (1 - 1). `orderId` pháº£i UNIQUE Ä‘á»ƒ Prisma hiá»ƒu 1-1
  payment Payment?

  // ğŸ”¹ Quan há»‡ Order <-> Address (n - 1) vá»›i tÃªn "OrderAddress"
  address   Address? @relation("OrderAddress", fields: [addressId], references: [id])
  addressId String?

  // ğŸ”¹ Quan há»‡ Order <-> User (n - 1) vá»›i tÃªn "UserOrders"
  user   User?   @relation("UserOrders", fields: [userId], references: [id])
  userId String?

  @@index([addressId])
  @@index([userId])
}

model OrderItem {
  id String @id @default(cuid())

  // ğŸ”¹ Nhiá»u item thuá»™c 1 order
  order   Order  @relation(fields: [orderId], references: [id])
  orderId String

  sku      String
  name     String
  quantity Int
  price    Int
  image    String?
}

model Payment {
  id String @id @default(cuid())

  // ğŸ”¹ 1-1 vá»›i Order: orderId pháº£i UNIQUE Ä‘á»ƒ khÃ´ng thÃ nh 1-n
  order   Order  @relation(fields: [orderId], references: [id])
  orderId String @unique

  method String // "cod" | "vnpay" | "credit" | "bank" (string Ä‘á»ƒ linh hoáº¡t)
  amount Int
  paidAt DateTime? @default(now())
}
