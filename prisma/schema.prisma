// ================================================
// GENERATORS & DATASOURCE
// ================================================
generator client_types {
  provider = "prisma-client"
  output   = "../generated"
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ================================================
// ENUMS HỆ THỐNG
// ================================================
enum Role {
  USER
  STAFF
  ADMIN
}

enum OrderStatus {
  pending
  paid
  processing
  shipped
  delivered
  cancelled
}

enum PublishStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum CartStatus {
  ACTIVE
  CHECKOUT
  COMPLETED
  ABANDONED
}

// ================================================
// USER / ADDRESS / ORDER / PAYMENT
// ================================================
model User {
  id            String   @id @default(cuid())
  username      String   @unique
  passwordHash  String
  fullName      String
  email         String   @unique
  phoneE164     String   @unique
  taxCode       String?  @db.VarChar(13)
  emailVerified Boolean  @default(false)
  role          Role     @default(USER)
  avatarUrl     String?  @default("/logo.png")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  shippingAddressId String   @unique
  billingAddressId  String?  @unique
  shippingAddress   Address  @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress    Address? @relation("BillingAddress", fields: [billingAddressId], references: [id])

  orders Order[]  @relation("UserOrders")
  Review Review[]
}

model Address {
  id         String   @id @default(cuid())
  line1      String
  line2      String?
  city       String
  state      String?
  postalCode String?
  country    String   @db.Char(2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  usersShipping User[]  @relation("ShippingAddress")
  usersBilling  User[]  @relation("BillingAddress")
  orders        Order[] @relation("OrderAddress")
}

model Order {
  id             String      @id @default(cuid())
  code           String      @unique
  status         OrderStatus @default(pending)
  customerName   String
  shippingMethod String?
  shippingFee    Int?
  note           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items   OrderItem[]
  payment Payment?

  address   Address? @relation("OrderAddress", fields: [addressId], references: [id])
  addressId String?

  user   User?   @relation("UserOrders", fields: [userId], references: [id])
  userId String?

  @@index([addressId])
  @@index([userId])
}

model OrderItem {
  id String @id @default(cuid())

  order   Order  @relation(fields: [orderId], references: [id])
  orderId String

  sku      String
  name     String
  quantity Int
  price    Int
  image    String? @db.Text
}

model Payment {
  id String @id @default(cuid())

  order   Order  @relation(fields: [orderId], references: [id])
  orderId String @unique

  method String
  amount Int
  paidAt DateTime? @default(now())
}

// ================================================
// SOLUTION CATALOG
// ================================================
model SolutionCategory {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  image       String? @db.Text

  parentId String?
  parent   SolutionCategory?  @relation("SolutionCategoryToParent", fields: [parentId], references: [id])
  children SolutionCategory[] @relation("SolutionCategoryToParent")

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  solutions Solution[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId, sortOrder])
}

model Solution {
  id         String  @id @default(cuid())
  title      String
  slug       String  @unique
  summary    String?
  coverImage String? @db.Text
  bodyHtml   String  @db.LongText

  industry String?
  usecase  String?

  status      PublishStatus @default(DRAFT)
  publishedAt DateTime?

  metaTitle       String?
  metaDescription String?
  canonicalUrl    String?

  categoryId String
  category   SolutionCategory @relation(fields: [categoryId], references: [id])

  images SolutionImage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId, status])
  @@fulltext([title, bodyHtml, usecase])
}

model SolutionImage {
  id         String   @id @default(cuid())
  solutionId String
  solution   Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  url       String
  alt       String?
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())

  @@index([solutionId, sortOrder])
}

// ================================================
// SOFTWARE CATALOG
// ================================================
model SoftwareCategory {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  image       String? @db.Text

  parentId String?
  parent   SoftwareCategory?  @relation("SoftwareCategoryToParent", fields: [parentId], references: [id])
  children SoftwareCategory[] @relation("SoftwareCategoryToParent")

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  softwares Software[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId, sortOrder])
}

model Software {
  id         String  @id @default(cuid())
  title      String
  slug       String  @unique
  summary    String?
  coverImage String? @db.Text
  bodyHtml   String  @db.LongText

  status      PublishStatus @default(DRAFT)
  publishedAt DateTime?

  metaTitle       String?
  metaDescription String?
  canonicalUrl    String?

  categoryId String
  category   SoftwareCategory @relation(fields: [categoryId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId, status])
  @@fulltext([title, bodyHtml])
}

// ================================================
// PRODUCT CATALOG
// ================================================
model Brand {
  id           String    @id @default(cuid())
  slug         String    @unique
  logoUrl      String?   @db.Text
  name         String
  summary      String?
  productCount Int       @default(0)
  products     Product[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model ProductCategory {
  id          String  @id @default(cuid())
  slug        String  @unique
  name        String
  coverImage  String? @db.Text
  description String?

  productLinks ProductCategoryLink[]
  productCount Int                   @default(0)

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  ProductType ProductType[]

  @@index([name])
  @@index([productCount])
}

model ProductCategoryLink {
  productId  String
  categoryId String

  product  Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  category ProductCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId])
  @@index([categoryId])
}

model ProductType {
  id          String  @id @default(cuid())
  slug        String
  name        String
  coverImage  String? @db.Text
  description String?

  categoryId String
  category   ProductCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  productCount Int       @default(0)
  products     Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([categoryId, slug])
  @@index([name])
  @@index([categoryId])
  @@index([productCount])
}

model UnitDefinition {
  id           String   @id @default(cuid())
  name         String   @unique
  symbol       String?
  dimension    String?
  baseName     String?
  factorToBase Decimal? @db.Decimal(20, 8)

  productsByUnit    Product[] @relation("ProductBaseUnit")
  productsByQtyUnit Product[] @relation("ProductQtyUnit")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductSpecDefinition {
  id   String @id @default(cuid())
  name String
  slug String @unique

  productSpecs ProductSpecValue[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model Product {
  id          String  @id @default(cuid())
  slug        String  @unique
  name        String
  sku         String  @unique
  description String?
  coverImage  String? @db.Text

  metaTitle       String?
  metaDescription String?
  status          PublishStatus @default(DRAFT)
  publishAt       DateTime?

  images ProductImage[]
  specs  ProductSpecValue[]

  price         Decimal  @db.Decimal(12, 2)
  listPrice     Decimal? @db.Decimal(12, 2)
  currency      String   @default("VND")
  taxIncluded   Boolean  @default(true)
  stockOnHand   Int      @default(0)
  stockReserved Int      @default(0)

  weightGrams Int?
  lengthMm    Int?
  widthMm     Int?
  heightMm    Int?

  typeId String
  type   ProductType @relation(fields: [typeId], references: [id], onDelete: Restrict)

  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id], onDelete: SetNull)

  categoryLinks ProductCategoryLink[]

  unitId String?
  unit   UnitDefinition? @relation("ProductBaseUnit", fields: [unitId], references: [id], onDelete: SetNull)

  quantityValue  Decimal?        @db.Decimal(20, 6)
  quantityUnitId String?
  quantityUnit   UnitDefinition? @relation("ProductQtyUnit", fields: [quantityUnitId], references: [id], onDelete: SetNull)
  quantityLabel  String?

  minOrderQty Int? @default(1)
  stepQty     Int? @default(1)

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  CartItem  CartItem[]

  // ⭐ Counters & reviews
  ratingAvg     Float    @default(0) // sao trung bình (1..5)
  ratingCount   Int      @default(0) // số lượt đánh giá
  purchaseCount Int      @default(0) // số lượt mua
  reviews       Review[] // quan hệ 1-n với Review

  @@index([name])
  @@index([brandId])
  @@index([typeId])
  @@index([price])
  @@index([quantityUnitId])
  @@index([quantityValue])
  @@index([status, publishAt])
  @@index([ratingAvg])
  @@index([ratingCount])
  @@index([purchaseCount])
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  url       String @db.Text
  alt       String?
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([sortOrder])
}

model ProductSpecValue {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  specDefinitionId String
  specDefinition   ProductSpecDefinition @relation(fields: [specDefinitionId], references: [id], onDelete: Restrict)

  valueString  String?
  valueNumber  Float?
  valueBoolean Boolean?

  unitOverride String?
  note         String?
  sortOrder    Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, specDefinitionId])
  @@index([specDefinitionId])
  @@index([sortOrder])
}

// ================================================
// SHOPPING CART
// ================================================
model Cart {
  id     String     @id @default(cuid())
  userId String?
  status CartStatus @default(ACTIVE)

  currency      String  @default("VND")
  subtotal      Decimal @default(0) @db.Decimal(12, 2)
  discountTotal Decimal @default(0) @db.Decimal(12, 2)
  taxTotal      Decimal @default(0) @db.Decimal(12, 2)
  shippingFee   Decimal @default(0) @db.Decimal(12, 2)
  grandTotal    Decimal @default(0) @db.Decimal(12, 2)

  items CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model CartItem {
  id String @id @default(cuid())

  cartId String
  cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  productName  String
  productSku   String
  productSlug  String
  productImage String? @db.Text
  brandName    String?

  unitLabel     String?
  quantityLabel String?

  unitPrice   Decimal @db.Decimal(12, 2)
  currency    String  @default("VND")
  taxIncluded Boolean @default(true)

  quantity  Int     @default(1)
  lineTotal Decimal @db.Decimal(12, 2)

  addedAt DateTime @default(now())

  @@index([cartId])
  @@index([productId])
}

model Review {
  id        String  @id @default(cuid())
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  rating      Int
  feedback    String?
  description String?
  reply       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // ảnh đính kèm
  images ReviewImage[]

  @@index([productId])
  @@index([userId])
}

model ReviewImage {
  id        String   @id @default(cuid())
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reviewId  String
  url       String
  alt       String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  @@index([reviewId])
}
